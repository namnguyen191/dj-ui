import{a as p,f as J,g as V,i as K,j as Q,l as X,m as R}from"./chunk-4RBRHGVV.js";import{a as W,b as G,c as N,e as Y}from"./chunk-SFXEP7JI.js";import{B as C,D as f,Ec as B,J as L,L as H,N as k,P,R as F,S as M,T as l,U as A,V as D,Z as g,aa as U,da as d,f as T,g as j,gb as Z,i as w,ia as z,ja as m,l as u,qa as E,r as I,s as b,x as y}from"./chunk-AGCFPB43.js";import{a as x,b as v}from"./chunk-Q7L6LLAK.js";var ce=new U("CORE_LAYOUT_CONFIG");var fe=n=>{let a=Z(void 0);return B(e=>{let r=n().subscribe(o=>a.set(o));e(()=>{r.unsubscribe()})}),a};var me=n=>(e,t)=>t(e).pipe(L(n));var _=(()=>{class n{#e={};registerFetcher(e,t){this.#e[e]&&G(`Fetcher with id ${e} already exists. Registering it again will override it`),this.#e[e]=t}registerFetchers(e){for(let[t,r]of Object.entries(e))this.registerFetcher(t,r)}getFetcher(e){let t=this.#e[e];if(!t){let r=`Fetcher with id ${e} does not exists. Please register it first`;throw W(r),new Error(r)}return t}fetchData(e,t){return this.getFetcher(e)(t)}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var ne=p.strictObject({fetcherId:p.string(),configs:p.unknown(),interpolation:K.optional()}),Ce=p.strictObject({id:p.string(),stateSubscription:X,options:p.strictObject({runCondition:p.boolean().optional(),requests:p.array(ne),onSuccess:p.array(J),parallel:p.boolean().optional()})}).describe("RemoteResourceTemplateSchema"),ee=(()=>{class n extends Y{constructor(){super(...arguments),this.missingTemplateEvent="MISSING_REMOTE_RESOURCE_TEMPLATE"}static{this.\u0275fac=(()=>{let e;return function(r){return(e||(e=E(n)))(r||n)}})()}static{this.\u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var $=class{constructor(){this.environmentInjector=d(z),this.interpolationService=d(Q)}setLoadingState(a){let e=a.getValue();a.next(v(x({},e),{isLoading:!0}))}setErrorState(a){a.next({status:"error",isLoading:!1,isError:!0,result:null})}setCompleteState(a,e){a.next({status:"completed",isLoading:!1,isError:!1,result:e})}interpolateResourceHooks(a){let{onSuccessHooks:e,resourceResult:t,stateSubscription:r}=a;return this.getResourceRequestHooksInterpolationContext(t,r).pipe(l(s=>this.interpolationService.interpolate({value:e,context:s})),f(()=>(console.warn("Failed to interpolate resource hooks"),u([]))))}getResourceRequestConfigInterpolationContext(a,e){let t=e?m(this.environmentInjector,()=>R(e)):u(null),r=u(a);return b({$requests:r,state:t}).pipe(F({refCount:!0,bufferSize:1}))}getResourceRequestTransformationInterpolationContext(a){let{accumulatedRequestsResults:e,currentRequestResult:t,stateSubscriptionConfig:r}=a,o=r?m(this.environmentInjector,()=>R(r)):u(null),c=u(e),s=u(t);return b({$requests:c,state:o,$current:s}).pipe(F({refCount:!0,bufferSize:1}))}getResourceRequestHooksInterpolationContext(a,e){let t=e?m(this.environmentInjector,()=>R(e)):u(null),r=u(a);return b({$result:r,state:t}).pipe(F({refCount:!0,bufferSize:1}))}};var te="[Resource did not run]",oe=Symbol("Complete"),re=u(oe),Ue=n=>{let a=d(se),e=n.reduce((t,r)=>v(x({},t),{[r]:a.getRemoteResourceState(r)}),{});return b(e).pipe(I(t=>{let r=Object.entries(t).every(([,i])=>i.isLoading),o=Object.entries(t).reduce((i,[S,h])=>h.isLoading?[...i,S]:i,[]),c=Object.entries(t).every(([,i])=>i.isError),s=Object.entries(t).reduce((i,[S,h])=>h.isError?[...i,S]:i,[]);return{results:t,isAllLoading:r,isPartialLoading:o,isAllError:c,isPartialError:s}}))},se=(()=>{class n extends ${#e={};#t=new T;#n=new j(null);#r=d(_);#s=d(ee);#i=d(V);getRemoteResourceState(e){let t=this.#e[e];return t?t.asObservable():this.#o(e)}triggerResource(e){this.#e[e]?this.reloadResource(e):this.#o(e)}reloadResource(e){this.#t.next(e)}#c(e,t){let r=0;return u([]).pipe(H(o=>{if(r>=e.length)return w;let c=e[r];return r++,this.#p({req:c,accumulatedRequestsResults:o,stateSubscriptionConfig:t}).pipe(l(s=>this.#r.fetchData(c.fetcherId,s)),l(s=>this.#m(c,s,o)),I(s=>[...o,s]))}),P(),I(o=>o[e.length-1]))}#a(e,t){return this.#f(e,t).pipe(l(r=>y(r.map(({fetcherId:o,configs:c})=>this.#r.fetchData(o,c)))),l(r=>this.#h({reqs:e,responses:r,stateSubscriptionConfig:t})))}#u(e){let t=this.#e[e];if(!t){console.warn(`Remote resource ${e} has not been registered or is not associated with any widget yet`);return}let r=this.#s.getTemplate(e),o=this.#l(r,t),c=this.#t.pipe(C(i=>i===e)),s=r.pipe(C(i=>i.status==="loaded"),l(i=>{let S=i.config.stateSubscription,h=u(w);return S&&(h=m(this.environmentInjector,()=>R(S))),h}));b([c.pipe(M(!0)),s]).pipe(l(()=>o),A(this.#n.pipe(C(i=>i===e)))).subscribe(()=>{N(`Remote resource ${e} triggered`)})}#l(e,t){return e.pipe(C(r=>r.status==="loaded"),D({next:()=>this.setLoadingState(t)}),l(r=>this.#R(r.config).pipe(I(o=>({result:o,rrt:r})))),l(({result:r,rrt:o})=>(this.setCompleteState(t,r),this.#g({resourceResult:r,remoteResourceTemplate:o}))),f(()=>(this.setErrorState(t),re)))}#p(e){let{req:t,accumulatedRequestsResults:r,stateSubscriptionConfig:o}=e;return this.getResourceRequestConfigInterpolationContext(r,o).pipe(l(i=>this.interpolationService.interpolate({value:t.configs,context:i})),f(i=>(console.warn(`Fail to interpolate request options: ${i}`),i)),k())}#f(e,t){let r=t?m(this.environmentInjector,()=>R(t)):u(null),o=e.map(s=>({fetcherId:s.fetcherId,configs:s.configs}));return r.pipe(l(s=>this.interpolationService.interpolate({value:o,context:s??{}})),f(s=>(console.warn("Fail to interpolate parallel requests options"),s)))}#m(e,t,r){let{interpolation:o}=e;return o?this.getResourceRequestTransformationInterpolationContext({accumulatedRequestsResults:r,currentRequestResult:t}).pipe(l(i=>this.interpolationService.interpolate({value:o,context:i})),f(i=>(console.warn("Failed to interpolate sequenced request result: ",i),i))):u(t)}#h(e){let{reqs:t,responses:r,stateSubscriptionConfig:o}=e,c=[];for(let s=0;s<t.length;s++){let{interpolation:i}=t[s];if(i){let h=this.getResourceRequestTransformationInterpolationContext({currentRequestResult:r[s],stateSubscriptionConfig:o}).pipe(l(q=>this.interpolationService.interpolate({value:i,context:q})),f(q=>(console.warn("Failed to interpolate parallel request result",q),q)),k());c.push(h)}}return y(c)}#o(e){let t=new j({status:"init",isLoading:!0,isError:!1,result:null});return this.#e[e]=t,this.#u(e),t.asObservable()}#g(e){let{resourceResult:t,remoteResourceTemplate:r}=e,{config:{options:{onSuccess:o},stateSubscription:c}}=r;return!o?.length||t===te?re:this.interpolateResourceHooks({onSuccessHooks:o,resourceResult:t,stateSubscription:c}).pipe(I(s=>(m(this.environmentInjector,()=>{this.#i.triggerActionHooks(s)}),oe)))}#d(e){let{stateSubscription:t,runCondition:r}=e;return(t?m(this.environmentInjector,()=>R(t)):u({})).pipe(l(c=>this.interpolationService.interpolate({value:r,context:{state:c}})),f(c=>(console.warn("Failed to interpolate resource run condition: ",c),u(!1))))}#R(e){let{stateSubscription:t,options:{runCondition:r=!0,requests:o,parallel:c}}=e;return this.#d({stateSubscription:t,runCondition:r}).pipe(l(s=>s?c?this.#a(o,t):this.#c(o,t):u(te)))}static{this.\u0275fac=(()=>{let e;return function(r){return(e||(e=E(n)))(r||n)}})()}static{this.\u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var Be=(()=>{class n{#e={};#t={};registerUIElement(e){let{type:t,component:r}=e;this.#e[t]=r}registerUIElementLoader(e){let{type:t,loader:r}=e;this.#t[t]=r}getUIElement(e){let t=this.#e[e];if(!t){let r=this.#t[e];if(r)return r();throw new Error(`${e} has not been registered as a UI Element yet!`)}return Promise.resolve(t)}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{fe as a,me as b,ce as c,_ as d,ee as e,Ue as f,se as g,Be as h};
