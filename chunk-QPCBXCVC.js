import{e as J}from"./chunk-HNFNR3GG.js";import{h as M,j as z,k as D,l as B,n as W,q as R}from"./chunk-POJFSOR5.js";import{C as j,E as x,F as p,M as O,O as k,Q as H,S as C,T,U as a,V as y,W as L,_ as I,a as v,b,ea as m,ha as P,ia as h,j as E,k as F,n as w,oa as A,q as c,w as d,x as S}from"./chunk-CELOEL42.js";var U=(()=>{class l{#e={};registerFetcher(e,t){this.#e[e]&&D(`Fetcher with id ${e} already exists. Registering it again will override it`),this.#e[e]=t}registerFetchers(e){for(let[t,o]of Object.entries(e))this.registerFetcher(t,o)}getFetcher(e){let t=this.#e[e];if(!t){let o=`Fetcher with id ${e} does not exists. Please register it first`;throw z(o),new Error(o)}return t}fetchData(e,t){return this.getFetcher(e)(t)}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=I({token:l,factory:l.\u0275fac,providedIn:"root"})}}return l})();var $=class{constructor(){this.environmentInjector=m(P),this.interpolationService=m(W)}setLoadingState(u){let e=u.getValue();u.next(b(v({},e),{isLoading:!0}))}setErrorState(u){u.next({status:"error",isLoading:!1,isError:!0,result:null})}setCompleteState(u,e){u.next({status:"completed",isLoading:!1,isError:!1,result:e})}interpolateResourceHooks(u){let{onSuccessHooks:e,resourceResult:t,stateSubscription:o}=u;return this.getResourceRequestHooksInterpolationContext(t,o).pipe(a(n=>this.interpolationService.interpolate({value:e,context:n})),p(()=>(console.warn("Failed to interpolate resource hooks"),c([]))))}getResourceRequestConfigInterpolationContext(u,e){let t=e?h(this.environmentInjector,()=>R(e,"Resource configs interpolation context")):c(null),o=c(u);return S({$requests:o,state:t}).pipe(C({refCount:!0,bufferSize:1}))}getResourceRequestTransformationInterpolationContext(u){let{accumulatedRequestsResults:e,currentRequestResult:t,stateSubscriptionConfig:o}=u,r=o?h(this.environmentInjector,()=>R(o,"Resource transformation interpolation context")):c(null),i=c(e),n=c(t);return S({$requests:i,state:r,$current:n}).pipe(C({refCount:!0,bufferSize:1}))}getResourceRequestHooksInterpolationContext(u,e){let t=e?h(this.environmentInjector,()=>R(e,"Resource hooks interpolation context")):c(null),o=c(u);return S({$result:o,state:t}).pipe(C({refCount:!0,bufferSize:1}))}};var V="[Resource did not run]",G=Symbol("Complete"),Y=c(G),ge=l=>{let u=m(N),e=l.reduce((t,o)=>b(v({},t),{[o]:u.getRemoteResourceState(o)}),{});return S(e).pipe(d(t=>{let o=Object.entries(t).every(([,s])=>s.isLoading),r=Object.entries(t).reduce((s,[g,f])=>f.isLoading?[...s,g]:s,[]),i=Object.entries(t).every(([,s])=>s.isError),n=Object.entries(t).reduce((s,[g,f])=>f.isError?[...s,g]:s,[]);return{results:t,isAllLoading:o,isPartialLoading:r,isAllError:i,isPartialError:n}}))},N=(()=>{class l extends ${#e={};#t=new E;#n=new F(null);#o=m(U);#s=m(J);#i=m(M);getRemoteResourceState(e){let t=this.#e[e];return t?t.asObservable():this.#r(e)}triggerResource(e){this.#e[e]?this.reloadResource(e):this.#r(e)}reloadResource(e){this.#t.next(e)}#c(e,t){let o=0;return c([]).pipe(O(r=>{if(o>=e.length)return w;let i=e[o];return o++,this.#p({req:i,accumulatedRequestsResults:r,stateSubscriptionConfig:t}).pipe(a(n=>this.#o.fetchData(i.fetcherId,n)),a(n=>this.#f(i,n,r)),d(n=>[...r,n]))}),H(),d(r=>r[e.length-1]))}#a(e,t){return this.#h(e,t).pipe(a(o=>j(o.map(({fetcherId:r,configs:i})=>this.#o.fetchData(r,i)))),a(o=>this.#m({reqs:e,responses:o,stateSubscriptionConfig:t})))}#u(e){let t=this.#e[e];if(!t){console.warn(`Remote resource ${e} has not been registered or is not associated with any widget yet`);return}let o=this.#s.getTemplate(e),r=this.#l(o,t),i=this.#t.pipe(x(s=>s===e)),n=o.pipe(x(s=>s.status==="loaded"),a(s=>{let g=s.config.stateSubscription,f=c(w);return g&&(f=h(this.environmentInjector,()=>R(g,`Remote resource refresh trigger for ${e}`))),f}));S([i.pipe(T(!0)),n]).pipe(a(()=>r),y(this.#n.pipe(x(s=>s===e)))).subscribe(()=>{B(`Remote resource ${e} triggered`)})}#l(e,t){return e.pipe(x(o=>o.status==="loaded"),L({next:()=>{this.setLoadingState(t)}}),a(o=>this.#S(o.config).pipe(d(r=>({result:r,rrt:o})))),a(({result:o,rrt:r})=>(this.setCompleteState(t,o),this.#R({resourceResult:o,remoteResourceTemplate:r}))),p(()=>(this.setErrorState(t),Y)))}#p(e){let{req:t,accumulatedRequestsResults:o,stateSubscriptionConfig:r}=e;return this.getResourceRequestConfigInterpolationContext(o,r).pipe(a(s=>this.interpolationService.interpolate({value:t.configs,context:s})),p(s=>{throw console.warn(`Fail to interpolate request options: ${s}`),s}),k())}#h(e,t){let o=t?h(this.environmentInjector,()=>R(t,"Parallel resource request options interpolation context")):c(null),r=e.map(n=>({fetcherId:n.fetcherId,configs:n.configs}));return o.pipe(a(n=>this.interpolationService.interpolate({value:r,context:n??{}})),p(n=>{throw console.warn("Fail to interpolate parallel requests options"),n}))}#f(e,t,o){let{interpolation:r}=e;return r?this.getResourceRequestTransformationInterpolationContext({accumulatedRequestsResults:o,currentRequestResult:t}).pipe(a(s=>this.interpolationService.interpolate({value:r,context:s})),p(s=>{throw console.warn("Failed to interpolate sequenced request result: ",s),s})):c(t)}#m(e){let{reqs:t,responses:o,stateSubscriptionConfig:r}=e,i=[];for(let n=0;n<t.length;n++){let{interpolation:s}=t[n];if(s){let f=this.getResourceRequestTransformationInterpolationContext({currentRequestResult:o[n],stateSubscriptionConfig:r}).pipe(a(q=>this.interpolationService.interpolate({value:s,context:q})),p(q=>{throw console.warn("Failed to interpolate parallel request result",q),q}),k());i.push(f)}}return j(i)}#r(e){let t=new F({status:"init",isLoading:!0,isError:!1,result:null});return this.#e[e]=t,this.#u(e),t.asObservable()}#R(e){let{resourceResult:t,remoteResourceTemplate:o}=e,{config:{options:{onSuccess:r},stateSubscription:i}}=o;return!r?.length||t===V?Y:this.interpolateResourceHooks({onSuccessHooks:r,resourceResult:t,stateSubscription:i}).pipe(d(n=>(h(this.environmentInjector,()=>{this.#i.triggerActionHooks(n)}),G)))}#g(e){let{stateSubscription:t,runCondition:o}=e;return(t?h(this.environmentInjector,()=>R(t,"Resource run condition")):c({})).pipe(a(i=>this.interpolationService.interpolate({value:o,context:{state:i}})),p(i=>(console.warn("Failed to interpolate resource run condition: ",i),c(!1))))}#S(e){let{stateSubscription:t,options:{runCondition:o=!0,requests:r,parallel:i}}=e;return this.#g({stateSubscription:t,runCondition:o}).pipe(a(n=>n?i?this.#a(r,t):this.#c(r,t):c(V)))}static{this.\u0275fac=(()=>{let e;return function(o){return(e||(e=A(l)))(o||l)}})()}static{this.\u0275prov=I({token:l,factory:l.\u0275fac,providedIn:"root"})}}return l})();export{U as a,ge as b,N as c};
