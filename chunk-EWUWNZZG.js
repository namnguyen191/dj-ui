import{a as ee}from"./chunk-CB73VGS7.js";import{g as Z,j as _,m as g}from"./chunk-RNE5JESU.js";import{a as J,b as K,c as X}from"./chunk-SPYAYC6H.js";import{$ as M,$b as G,Aa as q,B as v,Cc as N,D as p,Da as V,I as L,K as H,M as j,O as D,Q as E,R as P,S as l,T as U,U as A,Y as C,_b as Y,ca as h,f as T,g as w,gb as k,ha as B,hb as z,i as $,ia as m,l as u,nb as Q,pa as W,r as S,s as d,x as y}from"./chunk-J33AFEAQ.js";import{a as b,b as I}from"./chunk-VKRCUX5N.js";var se=["uiElementVCR"],le=(()=>{class i{constructor(){this.uiElementTemplate=q.required(),this.uiElementInstance=q.required(),this.uiElementComponentRef=q.required(),this.uiElementVCR=z("uiElementVCR",{read:k})}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275dir=Q({type:i,viewQuery:function(t,r){t&1&&Y(r.uiElementVCR,se,5,k),t&2&&G()},inputs:{uiElementTemplate:[1,"uiElementTemplate"],uiElementInstance:[1,"uiElementInstance"],uiElementComponentRef:[1,"uiElementComponentRef"]}})}}return i})();var he=new M("CORE_LAYOUT_CONFIG");var Ce=i=>{let a=V(void 0);return N(e=>{let r=i().subscribe(o=>a.set(o));e(()=>{r.unsubscribe()})}),a};var be=i=>(e,t)=>t(e).pipe(L(i));var te=(()=>{class i{#e={};registerFetcher(e,t){this.#e[e]&&K(`Fetcher with id ${e} already exists. Registering it again will override it`),this.#e[e]=t}registerFetchers(e){for(let[t,r]of Object.entries(e))this.registerFetcher(t,r)}getFetcher(e){let t=this.#e[e];if(!t){let r=`Fetcher with id ${e} does not exists. Please register it first`;throw J(r),new Error(r)}return t}fetchData(e,t){return this.getFetcher(e)(t)}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var F=class{constructor(){this.environmentInjector=h(B),this.interpolationService=h(_)}setLoadingState(a){let e=a.getValue();a.next(I(b({},e),{isLoading:!0}))}setErrorState(a){a.next({status:"error",isLoading:!1,isError:!0,result:null})}setCompleteState(a,e){a.next({status:"completed",isLoading:!1,isError:!1,result:e})}interpolateResourceHooks(a){let{onSuccessHooks:e,resourceResult:t,stateSubscription:r}=a;return this.getResourceRequestHooksInterpolationContext(t,r).pipe(l(n=>this.interpolationService.interpolate({value:e,context:n})),p(()=>(console.warn("Failed to interpolate resource hooks"),u([]))))}getResourceRequestConfigInterpolationContext(a,e){let t=e?m(this.environmentInjector,()=>g(e)):u(null),r=u(a);return d({$requests:r,state:t}).pipe(E({refCount:!0,bufferSize:1}))}getResourceRequestTransformationInterpolationContext(a){let{accumulatedRequestsResults:e,currentRequestResult:t,stateSubscriptionConfig:r}=a,o=r?m(this.environmentInjector,()=>g(r)):u(null),c=u(e),n=u(t);return d({$requests:c,state:o,$current:n}).pipe(E({refCount:!0,bufferSize:1}))}getResourceRequestHooksInterpolationContext(a,e){let t=e?m(this.environmentInjector,()=>g(e)):u(null),r=u(a);return d({$result:r,state:t}).pipe(E({refCount:!0,bufferSize:1}))}};var re="[Resource did not run]",ne=Symbol("Complete"),oe=u(ne),Ve=i=>{let a=h(ie),e=i.reduce((t,r)=>I(b({},t),{[r]:a.getRemoteResourceState(r)}),{});return d(e).pipe(S(t=>{let r=Object.entries(t).every(([,s])=>s.isLoading),o=Object.entries(t).reduce((s,[R,f])=>f.isLoading?[...s,R]:s,[]),c=Object.entries(t).every(([,s])=>s.isError),n=Object.entries(t).reduce((s,[R,f])=>f.isError?[...s,R]:s,[]);return{results:t,isAllLoading:r,isPartialLoading:o,isAllError:c,isPartialError:n}}))},ie=(()=>{class i extends F{#e={};#t=new T;#n=new w(null);#r=h(te);#s=h(ee);#i=h(Z);getRemoteResourceState(e){let t=this.#e[e];return t?t.asObservable():this.#o(e)}triggerResource(e){this.#e[e]?this.reloadResource(e):this.#o(e)}reloadResource(e){this.#t.next(e)}#c(e,t){let r=0;return u([]).pipe(H(o=>{if(r>=e.length)return $;let c=e[r];return r++,this.#p({req:c,accumulatedRequestsResults:o,stateSubscriptionConfig:t}).pipe(l(n=>this.#r.fetchData(c.fetcherId,n)),l(n=>this.#f(c,n,o)),S(n=>[...o,n]))}),D(),S(o=>o[e.length-1]))}#a(e,t){return this.#m(e,t).pipe(l(r=>y(r.map(({fetcherId:o,configs:c})=>this.#r.fetchData(o,c)))),l(r=>this.#h({reqs:e,responses:r,stateSubscriptionConfig:t})))}#u(e){let t=this.#e[e];if(!t){console.warn(`Remote resource ${e} has not been registered or is not associated with any widget yet`);return}let r=this.#s.getTemplate(e),o=this.#l(r,t),c=this.#t.pipe(v(s=>s===e)),n=r.pipe(v(s=>s.status==="loaded"),l(s=>{let R=s.config.stateSubscription,f=u($);return R&&(f=m(this.environmentInjector,()=>g(R))),f}));d([c.pipe(P(!0)),n]).pipe(l(()=>o),U(this.#n.pipe(v(s=>s===e)))).subscribe(()=>{X(`Remote resource ${e} triggered`)})}#l(e,t){return e.pipe(v(r=>r.status==="loaded"),A({next:()=>this.setLoadingState(t)}),l(r=>this.#d(r.config).pipe(S(o=>({result:o,rrt:r})))),l(({result:r,rrt:o})=>(this.setCompleteState(t,r),this.#g({resourceResult:r,remoteResourceTemplate:o}))),p(()=>(this.setErrorState(t),oe)))}#p(e){let{req:t,accumulatedRequestsResults:r,stateSubscriptionConfig:o}=e;return this.getResourceRequestConfigInterpolationContext(r,o).pipe(l(s=>this.interpolationService.interpolate({value:t.configs,context:s})),p(s=>(console.warn(`Fail to interpolate request options: ${s}`),s)),j())}#m(e,t){let r=t?m(this.environmentInjector,()=>g(t)):u(null),o=e.map(n=>({fetcherId:n.fetcherId,configs:n.configs}));return r.pipe(l(n=>this.interpolationService.interpolate({value:o,context:n??{}})),p(n=>(console.warn("Fail to interpolate parallel requests options"),n)))}#f(e,t,r){let{interpolation:o}=e;return o?this.getResourceRequestTransformationInterpolationContext({accumulatedRequestsResults:r,currentRequestResult:t}).pipe(l(s=>this.interpolationService.interpolate({value:o,context:s})),p(s=>(console.warn("Failed to interpolate sequenced request result: ",s),s))):u(t)}#h(e){let{reqs:t,responses:r,stateSubscriptionConfig:o}=e,c=[];for(let n=0;n<t.length;n++){let{interpolation:s}=t[n];if(s){let f=this.getResourceRequestTransformationInterpolationContext({currentRequestResult:r[n],stateSubscriptionConfig:o}).pipe(l(x=>this.interpolationService.interpolate({value:s,context:x})),p(x=>(console.warn("Failed to interpolate parallel request result",x),x)),j());c.push(f)}}return y(c)}#o(e){let t=new w({status:"init",isLoading:!0,isError:!1,result:null});return this.#e[e]=t,this.#u(e),t.asObservable()}#g(e){let{resourceResult:t,remoteResourceTemplate:r}=e,{config:{options:{onSuccess:o},stateSubscription:c}}=r;return!o?.length||t===re?oe:this.interpolateResourceHooks({onSuccessHooks:o,resourceResult:t,stateSubscription:c}).pipe(S(n=>(m(this.environmentInjector,()=>{this.#i.triggerActionHooks(n)}),ne)))}#R(e){let{stateSubscription:t,runCondition:r}=e;return(t?m(this.environmentInjector,()=>g(t)):u({})).pipe(l(c=>this.interpolationService.interpolate({value:r,context:{state:c}})),p(c=>(console.warn("Failed to interpolate resource run condition: ",c),u(!1))))}#d(e){let{stateSubscription:t,options:{runCondition:r=!0,requests:o,parallel:c}}=e;return this.#R({stateSubscription:t,runCondition:r}).pipe(l(n=>n?c?this.#a(o,t):this.#c(o,t):u(re)))}static{this.\u0275fac=(()=>{let e;return function(r){return(e||(e=W(i)))(r||i)}})()}static{this.\u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Ye=(()=>{class i{#e={};#t={};registerUIElement(e){let{type:t,component:r}=e;this.#e[t]=r}registerUIElementLoader(e){let{type:t,loader:r}=e;this.#t[t]=r}getUIElement(e){let t=this.#e[e];if(!t){let r=this.#t[e];if(r)return r();throw new Error(`${e} has not been registered as a UI Element yet!`)}return Promise.resolve(t)}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{Ce as a,be as b,le as c,he as d,te as e,Ve as f,ie as g,Ye as h};
