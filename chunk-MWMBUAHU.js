import{d as me}from"./chunk-QZTN465A.js";import{e as le,g as P,i as pe,j as q,k,m as U,p as v,u as fe}from"./chunk-4JUAUIAF.js";import{Aa as ie,Ac as w,Bc as D,C as V,Ca as se,E as F,Ec as ue,F as b,J as Q,L as X,M as Z,O as W,Q as _,S as $,T as ee,U as p,V as O,W as M,X as te,_ as y,a as R,b as x,ba as ne,ea as f,fb as ae,ha as H,ia as E,j as L,k as T,lb as ce,n as j,oa as oe,p as J,q as u,w as g,x as I,xa as re,za as z,zc as B}from"./chunk-FB2JRMCH.js";var Y=a=>{let l=se(void 0);return D(e=>{let n=a().subscribe(o=>l.set(o));e(()=>{n.unsubscribe()})}),l};var G=a=>{let{ele:l,attrName:e,attrValue:t}=a,n=l.parentElement,o=[];for(;n;){let r=n.getAttribute(e);if(r===null){n=n.parentElement;continue}if(o.push(r),r===t)return{contains:!0,chain:o};n=n.parentElement}return{contains:!1,chain:o}};var he=(()=>{class a{#e={};registerFetcher(e,t){this.#e[e]&&q(`Fetcher with id ${e} already exists. Registering it again will override it`),this.#e[e]=t}registerFetchers(e){for(let[t,n]of Object.entries(e))this.registerFetcher(t,n)}getFetcher(e){let t=this.#e[e];if(!t){let n=`Fetcher with id ${e} does not exists. Please register it first`;throw pe(n),new Error(n)}return t}fetchData(e,t){return this.getFetcher(e)(t)}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=y({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();var A=class{constructor(){this.environmentInjector=f(H),this.interpolationService=f(U)}setLoadingState(l){let e=l.getValue();l.next(x(R({},e),{isLoading:!0}))}setErrorState(l){l.next({status:"error",isLoading:!1,isError:!0,result:null})}setCompleteState(l,e){l.next({status:"completed",isLoading:!1,isError:!1,result:e})}interpolateResourceHooks(l){let{onSuccessHooks:e,resourceResult:t,stateSubscription:n}=l;return this.getResourceRequestHooksInterpolationContext(t,n).pipe(p(i=>this.interpolationService.interpolate({value:e,context:i})),b(()=>(console.warn("Failed to interpolate resource hooks"),u([]))))}getResourceRequestConfigInterpolationContext(l,e){let t=e?E(this.environmentInjector,()=>v(e,"Resource configs interpolation context")):u(null),n=u(l);return I({$requests:n,state:t}).pipe($({refCount:!0,bufferSize:1}))}getResourceRequestTransformationInterpolationContext(l){let{accumulatedRequestsResults:e,currentRequestResult:t,stateSubscriptionConfig:n}=l,o=n?E(this.environmentInjector,()=>v(n,"Resource transformation interpolation context")):u(null),r=u(e),i=u(t);return I({$requests:r,state:o,$current:i}).pipe($({refCount:!0,bufferSize:1}))}getResourceRequestHooksInterpolationContext(l,e){let t=e?E(this.environmentInjector,()=>v(e,"Resource hooks interpolation context")):u(null),n=u(l);return I({$result:n,state:t}).pipe($({refCount:!0,bufferSize:1}))}};var de="[Resource did not run]",Re=Symbol("Complete"),ge=u(Re),Ee=a=>{let l=f(Se),e=a.reduce((t,n)=>x(R({},t),{[n]:l.getRemoteResourceState(n)}),{});return I(e).pipe(g(t=>{let n=Object.entries(t).every(([,s])=>s.isLoading),o=Object.entries(t).reduce((s,[m,h])=>h.isLoading?[...s,m]:s,[]),r=Object.entries(t).every(([,s])=>s.isError),i=Object.entries(t).reduce((s,[m,h])=>h.isError?[...s,m]:s,[]);return{results:t,isAllLoading:n,isPartialLoading:o,isAllError:r,isPartialError:i}}))},Se=(()=>{class a extends A{#e={};#t=new L;#o=new T(null);#r=f(he);#c=f(me);#u=f(P);getRemoteResourceState(e){let t=this.#e[e];return t?t.asObservable():this.#m(e)}triggerResource(e){this.#e[e]?this.reloadResource(e):this.#m(e)}reloadResource(e){this.#t.next(e)}#n(e,t){let n=0;return u([]).pipe(Z(o=>{if(n>=e.length)return j;let r=e[n];return n++,this.#a({req:r,accumulatedRequestsResults:o,stateSubscriptionConfig:t}).pipe(p(i=>this.#r.fetchData(r.fetcherId,i)),p(i=>this.#f(r,i,o)),g(i=>[...o,i]))}),_(),g(o=>o[e.length-1]))}#i(e,t){return this.#p(e,t).pipe(p(n=>V(n.map(({fetcherId:o,configs:r})=>this.#r.fetchData(o,r)))),p(n=>this.#h({reqs:e,responses:n,stateSubscriptionConfig:t})))}#s(e){let t=this.#e[e];if(!t){console.warn(`Remote resource ${e} has not been registered or is not associated with any widget yet`);return}let n=this.#c.getTemplate(e),o=this.#l(n,t),r=this.#t.pipe(F(s=>s===e)),i=n.pipe(F(s=>s.status==="loaded"),p(s=>{let m=s.config.stateSubscription,h=u(j);return m&&(h=E(this.environmentInjector,()=>v(m,`Remote resource refresh trigger for ${e}`))),h}));I([r.pipe(ee(!0)),i]).pipe(p(()=>o),O(this.#o.pipe(F(s=>s===e)))).subscribe(()=>{k(`Remote resource ${e} triggered`)})}#l(e,t){return e.pipe(F(n=>n.status==="loaded"),M({next:()=>this.setLoadingState(t)}),p(n=>this.#R(n.config).pipe(g(o=>({result:o,rrt:n})))),p(({result:n,rrt:o})=>(this.setCompleteState(t,n),this.#d({resourceResult:n,remoteResourceTemplate:o}))),b(()=>(this.setErrorState(t),ge)))}#a(e){let{req:t,accumulatedRequestsResults:n,stateSubscriptionConfig:o}=e;return this.getResourceRequestConfigInterpolationContext(n,o).pipe(p(s=>this.interpolationService.interpolate({value:t.configs,context:s})),b(s=>(console.warn(`Fail to interpolate request options: ${s}`),s)),W())}#p(e,t){let n=t?E(this.environmentInjector,()=>v(t,"Parallel resource request options interpolation context")):u(null),o=e.map(i=>({fetcherId:i.fetcherId,configs:i.configs}));return n.pipe(p(i=>this.interpolationService.interpolate({value:o,context:i??{}})),b(i=>(console.warn("Fail to interpolate parallel requests options"),i)))}#f(e,t,n){let{interpolation:o}=e;return o?this.getResourceRequestTransformationInterpolationContext({accumulatedRequestsResults:n,currentRequestResult:t}).pipe(p(s=>this.interpolationService.interpolate({value:o,context:s})),b(s=>(console.warn("Failed to interpolate sequenced request result: ",s),s))):u(t)}#h(e){let{reqs:t,responses:n,stateSubscriptionConfig:o}=e,r=[];for(let i=0;i<t.length;i++){let{interpolation:s}=t[i];if(s){let h=this.getResourceRequestTransformationInterpolationContext({currentRequestResult:n[i],stateSubscriptionConfig:o}).pipe(p(c=>this.interpolationService.interpolate({value:s,context:c})),b(c=>(console.warn("Failed to interpolate parallel request result",c),c)),W());r.push(h)}}return V(r)}#m(e){let t=new T({status:"init",isLoading:!0,isError:!1,result:null});return this.#e[e]=t,this.#s(e),t.asObservable()}#d(e){let{resourceResult:t,remoteResourceTemplate:n}=e,{config:{options:{onSuccess:o},stateSubscription:r}}=n;return!o?.length||t===de?ge:this.interpolateResourceHooks({onSuccessHooks:o,resourceResult:t,stateSubscription:r}).pipe(g(i=>(E(this.environmentInjector,()=>{this.#u.triggerActionHooks(i)}),Re)))}#g(e){let{stateSubscription:t,runCondition:n}=e;return(t?E(this.environmentInjector,()=>v(t,"Resource run condition")):u({})).pipe(p(r=>this.interpolationService.interpolate({value:n,context:{state:r}})),b(r=>(console.warn("Failed to interpolate resource run condition: ",r),u(!1))))}#R(e){let{stateSubscription:t,options:{runCondition:n=!0,requests:o,parallel:r}}=e;return this.#g({stateSubscription:t,runCondition:n}).pipe(p(i=>i?r?this.#i(o,t):this.#n(o,t):u(de)))}static{this.\u0275fac=(()=>{let e;return function(n){return(e||(e=oe(a)))(n||a)}})()}static{this.\u0275prov=y({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();var Ie=(()=>{class a{#e={};#t={};registerUIElement(e){let{type:t,component:n}=e;this.#e[t]=n}registerUIElementLoader(e){let{type:t,loader:n}=e;this.#t[t]=n}getUIElement(e){let t=this.#e[e];if(!t){let n=this.#t[e];if(n)return n();throw new Error(`${e} has not been registered as a UI Element yet!`)}return Promise.resolve(t)}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=y({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();var be=new ne("ELEMENT_RENDERER_CONFIG"),ht=(()=>{class a{constructor(){this.#e=f(Ie),this.#t=f(fe),this.#o=f(U),this.#r=f(H),this.#c=f(P),this.#u=f(ie),this.#n=f(ae),this.#i=f(be,{optional:!0})?.uiElementLoadingComponent,this.#s=f(be,{optional:!0})?.uiElementInfiniteErrorComponent,this.uiElementTemplateId=z.required({alias:"djuiUIElementRenderer"}),this.requiredComponentSymbols=z([]),this.uiElementTemplate=Y(()=>this.#t.getTemplate(this.uiElementTemplateId())),this.uiElementComponent=Y(()=>{let e=this.uiElementTemplate();return!e||!e.config?u(void 0):J(this.#e.getUIElement(e.config.type))}),this.#l=w(()=>{if(this.#n.clear(),this.uiElementTemplate()?.status!=="loaded")return this.#i&&this.#n.createComponent(this.#i),null;if(this.isInfinite())return this.#s&&this.#n.createComponent(this.#s),null;let e=this.uiElementComponent();if(!e)return null;let t=B(this.uiElementTemplateId),n=e.ELEMENT_SYMBOL,o=this.requiredComponentSymbols();return o.length&&!o.includes(n)?(q(`${t}: Wrong element received: expect ${o.map(r=>String(r)).join("or ")} but got ${String(n)}`),null):this.#n.createComponent(e)}),this.#a=w(()=>{let e=this.uiElementTemplate();if(!e||e.status!=="loaded")return null;let{remoteResourceIds:t,stateSubscription:n}=e.config,o=n?E(this.#r,()=>v(n,`UI Element ${e.id}`)):u(null),r=t?.length?E(this.#r,()=>Ee(t)):u(null);return I({remoteResourcesStates:r,state:o}).pipe($({refCount:!0,bufferSize:1}))}),this.#p=w(()=>{let e=this.uiElementTemplate(),t=this.#a();if(e?.status!=="loaded"||!t)return null;let{config:{options:n,remoteResourceIds:o}}=e,r=o?.length?this.#d({elementInterpolationContext$:t}):{isResourceLoading:u(!1),isResourceError:u(!1)},i=this.#m({templateOptions:n,elementInterpolationContext$:t}),s={isLoading:I({isResourceLoading:r.isResourceLoading,isInterpolationLoading:i.isInterpolationLoading}).pipe(g(({isResourceLoading:c,isInterpolationLoading:d})=>c||d)),isError:I({isResourceError:r.isResourceError,isInterpolationError:i.isInterpolationError}).pipe(g(({isResourceError:c,isInterpolationError:d})=>c||d))},m=R(R(R({},r),s),i);return Object.fromEntries(Object.entries(m).map(([c,d])=>[c,d.pipe(X(le),te(500,void 0,{leading:!0,trailing:!0}))]))}),this.isInfinite=w(()=>{let e=this.uiElementTemplateId(),t=this.#u.nativeElement,{contains:n,chain:o}=G({ele:t,attrName:"elementTemplateId",attrValue:e});if(n){let r=[...o,e].join(" -> ");console.error(`UI element with id ${e} has already existed in parents. Check ${r}`)}return n}),this.#f=D(e=>{let t=this.#p(),n=this.#l(),o=this.uiElementTemplate(),r=this.#a();if(!t||!n||o?.status!=="loaded"||!r)return;n.location.nativeElement.setAttribute("elementTemplateId",B(this.uiElementTemplateId));let i=new L;e(()=>{i.next(),i.complete()});for(let[m,h]of Object.entries(t))this.#h(n.componentType,m)?h.pipe(O(i)).subscribe(c=>{k(`[${this.uiElementTemplateId()}] Input stream for ${m}`),n.setInput(m,c)}):q(`Input ${m} does not exist for component ${n.instance.getElementType()}`);let{eventsHooks:s}=o.config;if(s)for(let[m,h]of Object.entries(s)){let c=n.instance[m];if(!c||!(c instanceof re))q(`Element ${n.instance.getElementType()} has no support for event "${m}"`);else{let d=r.pipe(Q(1));c.subscribe(N=>{d.pipe(p(S=>this.#o.interpolate({value:h,context:x(R({},S),{$eventOutput:N})}))).subscribe(S=>{k(`Output stream for ${this.uiElementTemplateId()}`),this.#c.triggerActionHooks(S)})})}}})}#e;#t;#o;#r;#c;#u;#n;#i;#s;#l;#a;#p;#f;#h(e,t){let n=ue(e)?.inputs;if(!n)throw new Error("Invalid component");return!!n.find(o=>o.propName===t||o.templateName===t)}#m(e){let{templateOptions:t,elementInterpolationContext$:n}=e,o=new T({}),r=o.asObservable().pipe(g(c=>!Object.values(c).every(d=>!d))),i=new T({}),s=i.asObservable().pipe(g(c=>!Object.values(c).every(d=>!d))),m={isInterpolationLoading:r,isInterpolationError:s},h={};for(let[c,d]of Object.entries(t)){let N=this.#o.checkForInterpolation(d);h[c]=N?n.pipe(p(S=>{let C=structuredClone(o.getValue());return C[c]=!0,o.next(C),this.#o.interpolate({context:S,value:d})}),b(S=>{let C=structuredClone(i.getValue());return C[c]=!0,i.next(C),console.warn(`Fail to interpolate ${c}. Error: ${S}`),j}),M({next:()=>{let S=structuredClone(i.getValue());S[c]=!1,i.next(S);let C=structuredClone(o.getValue());C[c]=!1,o.next(C)}})):u(d)}return R(R({},m),h)}#d(e){let{elementInterpolationContext$:t}=e;return{isResourceLoading:t.pipe(g(n=>!!n.remoteResourcesStates?.isPartialLoading.length)),isResourceError:t.pipe(g(n=>!!n.remoteResourcesStates?.isPartialError.length))}}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275dir=ce({type:a,selectors:[["","djuiUIElementRenderer",""]],inputs:{uiElementTemplateId:[1,"djuiUIElementRenderer","uiElementTemplateId"],requiredComponentSymbols:[1,"requiredComponentSymbols"]}})}}return a})();export{he as a,Se as b,Ie as c,be as d,ht as e};
