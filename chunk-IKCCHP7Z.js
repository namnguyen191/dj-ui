import{d as me}from"./chunk-TAWLDFJJ.js";import{e as le,g as A,i as pe,j as q,k,m as N,p as C,u as fe}from"./chunk-PFL7ZWEZ.js";import{Aa as ie,Ac as B,Bc as w,C as W,Ca as se,Cc as U,E as O,F as v,Fc as ue,J as Q,L as X,M as Z,O as z,Q as _,S as y,T as ee,U as p,V as M,W as H,X as te,_ as j,a as g,b as T,ba as ne,ea as f,fb as ce,ha as D,ia as I,j as L,k as $,mb as ae,n as F,oa as oe,p as J,q as a,w as R,x as S,xa as re,za as P}from"./chunk-CELOEL42.js";var Y=c=>{let l=se(void 0);return U(e=>{let n=c().subscribe(o=>l.set(o));e(()=>{n.unsubscribe()})}),l};var G=c=>{let{ele:l,attrName:e,attrValue:t}=c,n=l.parentElement,o=[];for(;n;){let r=n.getAttribute(e);if(r===null){n=n.parentElement;continue}if(o.push(r),r===t)return{contains:!0,chain:o};n=n.parentElement}return{contains:!1,chain:o}};var he=(()=>{class c{#e={};registerFetcher(e,t){this.#e[e]&&q(`Fetcher with id ${e} already exists. Registering it again will override it`),this.#e[e]=t}registerFetchers(e){for(let[t,n]of Object.entries(e))this.registerFetcher(t,n)}getFetcher(e){let t=this.#e[e];if(!t){let n=`Fetcher with id ${e} does not exists. Please register it first`;throw pe(n),new Error(n)}return t}fetchData(e,t){return this.getFetcher(e)(t)}static{this.\u0275fac=function(t){return new(t||c)}}static{this.\u0275prov=j({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();var V=class{constructor(){this.environmentInjector=f(D),this.interpolationService=f(N)}setLoadingState(l){let e=l.getValue();l.next(T(g({},e),{isLoading:!0}))}setErrorState(l){l.next({status:"error",isLoading:!1,isError:!0,result:null})}setCompleteState(l,e){l.next({status:"completed",isLoading:!1,isError:!1,result:e})}interpolateResourceHooks(l){let{onSuccessHooks:e,resourceResult:t,stateSubscription:n}=l;return this.getResourceRequestHooksInterpolationContext(t,n).pipe(p(i=>this.interpolationService.interpolate({value:e,context:i})),v(()=>(console.warn("Failed to interpolate resource hooks"),a([]))))}getResourceRequestConfigInterpolationContext(l,e){let t=e?I(this.environmentInjector,()=>C(e,"Resource configs interpolation context")):a(null),n=a(l);return S({$requests:n,state:t}).pipe(y({refCount:!0,bufferSize:1}))}getResourceRequestTransformationInterpolationContext(l){let{accumulatedRequestsResults:e,currentRequestResult:t,stateSubscriptionConfig:n}=l,o=n?I(this.environmentInjector,()=>C(n,"Resource transformation interpolation context")):a(null),r=a(e),i=a(t);return S({$requests:r,state:o,$current:i}).pipe(y({refCount:!0,bufferSize:1}))}getResourceRequestHooksInterpolationContext(l,e){let t=e?I(this.environmentInjector,()=>C(e,"Resource hooks interpolation context")):a(null),n=a(l);return S({$result:n,state:t}).pipe(y({refCount:!0,bufferSize:1}))}};var de="[Resource did not run]",Re=Symbol("Complete"),ge=a(Re),Ee=c=>{let l=f(Se),e=c.reduce((t,n)=>T(g({},t),{[n]:l.getRemoteResourceState(n)}),{});return S(e).pipe(R(t=>{let n=Object.entries(t).every(([,s])=>s.isLoading),o=Object.entries(t).reduce((s,[m,h])=>h.isLoading?[...s,m]:s,[]),r=Object.entries(t).every(([,s])=>s.isError),i=Object.entries(t).reduce((s,[m,h])=>h.isError?[...s,m]:s,[]);return{results:t,isAllLoading:n,isPartialLoading:o,isAllError:r,isPartialError:i}}))},Se=(()=>{class c extends V{#e={};#t=new L;#o=new $(null);#r=f(he);#a=f(me);#u=f(A);getRemoteResourceState(e){let t=this.#e[e];return t?t.asObservable():this.#m(e)}triggerResource(e){this.#e[e]?this.reloadResource(e):this.#m(e)}reloadResource(e){this.#t.next(e)}#n(e,t){let n=0;return a([]).pipe(Z(o=>{if(n>=e.length)return F;let r=e[n];return n++,this.#c({req:r,accumulatedRequestsResults:o,stateSubscriptionConfig:t}).pipe(p(i=>this.#r.fetchData(r.fetcherId,i)),p(i=>this.#f(r,i,o)),R(i=>[...o,i]))}),_(),R(o=>o[e.length-1]))}#i(e,t){return this.#p(e,t).pipe(p(n=>W(n.map(({fetcherId:o,configs:r})=>this.#r.fetchData(o,r)))),p(n=>this.#h({reqs:e,responses:n,stateSubscriptionConfig:t})))}#s(e){let t=this.#e[e];if(!t){console.warn(`Remote resource ${e} has not been registered or is not associated with any widget yet`);return}let n=this.#a.getTemplate(e),o=this.#l(n,t),r=this.#t.pipe(O(s=>s===e)),i=n.pipe(O(s=>s.status==="loaded"),p(s=>{let m=s.config.stateSubscription,h=a(F);return m&&(h=I(this.environmentInjector,()=>C(m,`Remote resource refresh trigger for ${e}`))),h}));S([r.pipe(ee(!0)),i]).pipe(p(()=>o),M(this.#o.pipe(O(s=>s===e)))).subscribe(()=>{k(`Remote resource ${e} triggered`)})}#l(e,t){return e.pipe(O(n=>n.status==="loaded"),H({next:()=>this.setLoadingState(t)}),p(n=>this.#R(n.config).pipe(R(o=>({result:o,rrt:n})))),p(({result:n,rrt:o})=>(this.setCompleteState(t,n),this.#d({resourceResult:n,remoteResourceTemplate:o}))),v(()=>(this.setErrorState(t),ge)))}#c(e){let{req:t,accumulatedRequestsResults:n,stateSubscriptionConfig:o}=e;return this.getResourceRequestConfigInterpolationContext(n,o).pipe(p(s=>this.interpolationService.interpolate({value:t.configs,context:s})),v(s=>(console.warn(`Fail to interpolate request options: ${s}`),s)),z())}#p(e,t){let n=t?I(this.environmentInjector,()=>C(t,"Parallel resource request options interpolation context")):a(null),o=e.map(i=>({fetcherId:i.fetcherId,configs:i.configs}));return n.pipe(p(i=>this.interpolationService.interpolate({value:o,context:i??{}})),v(i=>(console.warn("Fail to interpolate parallel requests options"),i)))}#f(e,t,n){let{interpolation:o}=e;return o?this.getResourceRequestTransformationInterpolationContext({accumulatedRequestsResults:n,currentRequestResult:t}).pipe(p(s=>this.interpolationService.interpolate({value:o,context:s})),v(s=>(console.warn("Failed to interpolate sequenced request result: ",s),s))):a(t)}#h(e){let{reqs:t,responses:n,stateSubscriptionConfig:o}=e,r=[];for(let i=0;i<t.length;i++){let{interpolation:s}=t[i];if(s){let h=this.getResourceRequestTransformationInterpolationContext({currentRequestResult:n[i],stateSubscriptionConfig:o}).pipe(p(u=>this.interpolationService.interpolate({value:s,context:u})),v(u=>(console.warn("Failed to interpolate parallel request result",u),u)),z());r.push(h)}}return W(r)}#m(e){let t=new $({status:"init",isLoading:!0,isError:!1,result:null});return this.#e[e]=t,this.#s(e),t.asObservable()}#d(e){let{resourceResult:t,remoteResourceTemplate:n}=e,{config:{options:{onSuccess:o},stateSubscription:r}}=n;return!o?.length||t===de?ge:this.interpolateResourceHooks({onSuccessHooks:o,resourceResult:t,stateSubscription:r}).pipe(R(i=>(I(this.environmentInjector,()=>{this.#u.triggerActionHooks(i)}),Re)))}#g(e){let{stateSubscription:t,runCondition:n}=e;return(t?I(this.environmentInjector,()=>C(t,"Resource run condition")):a({})).pipe(p(r=>this.interpolationService.interpolate({value:n,context:{state:r}})),v(r=>(console.warn("Failed to interpolate resource run condition: ",r),a(!1))))}#R(e){let{stateSubscription:t,options:{runCondition:n=!0,requests:o,parallel:r}}=e;return this.#g({stateSubscription:t,runCondition:n}).pipe(p(i=>i?r?this.#i(o,t):this.#n(o,t):a(de)))}static{this.\u0275fac=(()=>{let e;return function(n){return(e||(e=oe(c)))(n||c)}})()}static{this.\u0275prov=j({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();var Ie=(()=>{class c{#e={};#t={};registerUIElement(e){let{type:t,component:n}=e;this.#e[t]=n}registerUIElementLoader(e){let{type:t,loader:n}=e;this.#t[t]=n}getUIElement(e){let t=this.#e[e];if(!t){let n=this.#t[e];if(n)return n();throw new Error(`${e} has not been registered as a UI Element yet!`)}return Promise.resolve(t)}static{this.\u0275fac=function(t){return new(t||c)}}static{this.\u0275prov=j({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();var be=new ne("ELEMENT_RENDERER_CONFIG"),ht=(()=>{class c{constructor(){this.#e=f(Ie),this.#t=f(fe),this.#o=f(N),this.#r=f(D),this.#a=f(A),this.#u=f(ie),this.#n=f(ce),this.#i=f(be,{optional:!0})?.uiElementLoadingComponent,this.#s=f(be,{optional:!0})?.uiElementInfiniteErrorComponent,this.uiElementTemplateId=P.required({alias:"djuiUIElementRenderer"}),this.requiredComponentSymbols=P([]),this.configsOverride=P({}),this.uiElementTemplate=Y(()=>this.#t.getTemplate(this.uiElementTemplateId())),this.uiElementComponent=Y(()=>{let e=this.uiElementTemplate();return!e||!e.config?a(void 0):J(this.#e.getUIElement(e.config.type))}),this.#l=w(()=>{if(this.#n.clear(),this.uiElementTemplate()?.status!=="loaded")return this.#i&&this.#n.createComponent(this.#i),null;if(this.isInfinite())return this.#s&&this.#n.createComponent(this.#s),null;let e=this.uiElementComponent();if(!e)return null;let t=B(this.uiElementTemplateId),n=e.ELEMENT_SYMBOL,o=this.requiredComponentSymbols();return o.length&&!o.includes(n)?(q(`${t}: Wrong element received: expect ${o.map(r=>String(r)).join("or ")} but got ${String(n)}`),null):this.#n.createComponent(e)}),this.#c=w(()=>{let e=this.uiElementTemplate();if(!e||e.status!=="loaded")return null;let{remoteResourceIds:t,stateSubscription:n}=e.config,o=n?I(this.#r,()=>C(n,`UI Element ${e.id}`)):a(null),r=t?.length?I(this.#r,()=>Ee(t)):a(null);return S({remoteResourcesStates:r,state:o}).pipe(y({refCount:!0,bufferSize:1}))}),this.#p=w(()=>{let e=this.uiElementTemplate(),t=this.#c();if(e?.status!=="loaded"||!t)return null;let{config:{options:n,remoteResourceIds:o}}=e,r=o?.length?this.#d({elementInterpolationContext$:t}):{isResourceLoading:a(!1),isResourceError:a(!1)},i=this.#m({templateOptions:n,elementInterpolationContext$:t}),s={isLoading:S({isResourceLoading:r.isResourceLoading,isInterpolationLoading:i.isInterpolationLoading}).pipe(R(({isResourceLoading:d,isInterpolationLoading:b})=>d||b)),isError:S({isResourceError:r.isResourceError,isInterpolationError:i.isInterpolationError}).pipe(R(({isResourceError:d,isInterpolationError:b})=>d||b))},m=Object.entries(this.configsOverride()).reduce((d,[b,E])=>T(g({},d),{[b]:a(E)}),{}),h=g(g(g(g({},r),s),i),m);return Object.fromEntries(Object.entries(h).map(([d,b])=>[d,b.pipe(X(le),te(500,void 0,{leading:!0,trailing:!0}))]))}),this.isInfinite=w(()=>{let e=this.uiElementTemplateId(),t=this.#u.nativeElement,{contains:n,chain:o}=G({ele:t,attrName:"elementTemplateId",attrValue:e});if(n){let r=[...o,e].join(" -> ");console.error(`UI element with id ${e} has already existed in parents. Check ${r}`)}return n}),this.#f=U(e=>{let t=this.#p(),n=this.#l(),o=this.uiElementTemplate(),r=this.#c();if(!t||!n||o?.status!=="loaded"||!r)return;n.location.nativeElement.setAttribute("elementTemplateId",B(this.uiElementTemplateId));let i=new L;e(()=>{i.next(),i.complete()});for(let[m,h]of Object.entries(t))this.#h(n.componentType,m)?h.pipe(M(i)).subscribe(u=>{k(`[${this.uiElementTemplateId()}] Input stream for ${m}`),n.setInput(m,u)}):q(`Input ${m} does not exist for component ${n.instance.getElementType()}`);let{eventsHooks:s}=o.config;if(s)for(let[m,h]of Object.entries(s)){let u=n.instance[m];if(!u||!(u instanceof re))q(`Element ${n.instance.getElementType()} has no support for event "${m}"`);else{let d=r.pipe(Q(1));u.subscribe(b=>{d.pipe(p(E=>this.#o.interpolate({value:h,context:T(g({},E),{$eventOutput:b})}))).subscribe(E=>{k(`Output stream for ${this.uiElementTemplateId()}`),this.#a.triggerActionHooks(E)})})}}})}#e;#t;#o;#r;#a;#u;#n;#i;#s;#l;#c;#p;#f;#h(e,t){let n=ue(e)?.inputs;if(!n)throw new Error("Invalid component");return!!n.find(o=>o.propName===t||o.templateName===t)}#m(e){let{templateOptions:t,elementInterpolationContext$:n}=e,o=new $({}),r=o.asObservable().pipe(R(u=>!Object.values(u).every(d=>!d))),i=new $({}),s=i.asObservable().pipe(R(u=>!Object.values(u).every(d=>!d))),m={isInterpolationLoading:r,isInterpolationError:s},h={};for(let[u,d]of Object.entries(t)){let b=this.#o.checkForInterpolation(d);h[u]=b?n.pipe(p(E=>{let x=structuredClone(o.getValue());return x[u]=!0,o.next(x),this.#o.interpolate({context:E,value:d})}),v(E=>{let x=structuredClone(i.getValue());return x[u]=!0,i.next(x),console.warn(`Fail to interpolate ${u}. Error: ${E}`),F}),H({next:()=>{let E=structuredClone(i.getValue());E[u]=!1,i.next(E);let x=structuredClone(o.getValue());x[u]=!1,o.next(x)}})):a(d)}return g(g({},m),h)}#d(e){let{elementInterpolationContext$:t}=e;return{isResourceLoading:t.pipe(R(n=>!!n.remoteResourcesStates?.isPartialLoading.length)),isResourceError:t.pipe(R(n=>!!n.remoteResourcesStates?.isPartialError.length))}}static{this.\u0275fac=function(t){return new(t||c)}}static{this.\u0275dir=ae({type:c,selectors:[["","djuiUIElementRenderer",""]],inputs:{uiElementTemplateId:[1,"djuiUIElementRenderer","uiElementTemplateId"],requiredComponentSymbols:[1,"requiredComponentSymbols"],configsOverride:[1,"configsOverride"]}})}}return c})();export{he as a,Se as b,Ie as c,be as d,ht as e};
