import{f as re}from"./chunk-V4SGIPPW.js";import{h as Z,j as _,k as ee,l as te,n as oe,q as $}from"./chunk-XDSASVCN.js";import{A as w,B as F,Ba as X,G as B,I as j,J as b,Q as V,S as W,U as Y,W as T,X as G,Y as m,Z as K,_ as N,a as O,b as H,da as y,e as g,f as x,h as S,ia as I,la as Q,ma as v,n as U,o as z,r as D,u as f}from"./chunk-UJ7YJEPZ.js";var ne=(()=>{var n;let i=class i{constructor(){x(this,n,{})}registerFetcher(s,h){g(this,n)[s]&&ee(`Fetcher with id ${s} already exists. Registering it again will override it`),g(this,n)[s]=h}registerFetchers(s){for(let[h,R]of Object.entries(s))this.registerFetcher(h,R)}getFetcher(s){let h=g(this,n)[s];if(!h){let R=`Fetcher with id ${s} does not exists. Please register it first`;throw _(R),new Error(R)}return h}fetchData(s,h){return this.getFetcher(s)(h)}};n=new WeakMap,i.\u0275fac=function(h){return new(h||i)},i.\u0275prov=y({token:i,factory:i.\u0275fac,providedIn:"root"});let d=i;return d})();var L=class{constructor(){this.environmentInjector=I(Q),this.interpolationService=I(oe)}setLoadingState(n){let i=n.getValue();n.next(H(O({},i),{isLoading:!0}))}setErrorState(n){n.next({status:"error",isLoading:!1,isError:!0,result:null})}setCompleteState(n,i){n.next({status:"completed",isLoading:!1,isError:!1,result:i})}interpolateResourceHooks(n){let{onSuccessHooks:i,resourceResult:p,stateSubscription:s}=n;return this.getResourceRequestHooksInterpolationContext(p,s).pipe(m(r=>this.interpolationService.interpolate({value:i,context:r})),b(()=>(console.warn("Failed to interpolate resource hooks"),f([]))))}getResourceRequestConfigInterpolationContext(n,i){let p=i?v(this.environmentInjector,()=>$(i,"Resource configs interpolation context")):f(null),s=f(n);return F({$requests:s,state:p}).pipe(T({refCount:!0,bufferSize:1}))}getResourceRequestTransformationInterpolationContext(n){let{accumulatedRequestsResults:i,currentRequestResult:p,stateSubscriptionConfig:s}=n,h=s?v(this.environmentInjector,()=>$(s,"Resource transformation interpolation context")):f(null),R=f(i),r=f(p);return F({$requests:R,state:h,$current:r}).pipe(T({refCount:!0,bufferSize:1}))}getResourceRequestHooksInterpolationContext(n,i){let p=i?v(this.environmentInjector,()=>$(i,"Resource hooks interpolation context")):f(null),s=f(n);return F({$result:s,state:p}).pipe(T({refCount:!0,bufferSize:1}))}};var se="[Resource did not run]",ce=Symbol("Complete"),ie=f(ce),Je=d=>{let n=I(qe),i=d.reduce((p,s)=>H(O({},p),{[s]:n.getRemoteResourceState(s)}),{});return F(i).pipe(w(p=>{let s=Object.entries(p).every(([,q])=>q.isLoading),h=Object.entries(p).reduce((q,[P,A])=>A.isLoading?[...q,P]:q,[]),R=Object.entries(p).every(([,q])=>q.isError),r=Object.entries(p).reduce((q,[P,A])=>A.isError?[...q,P]:q,[]);return{results:p,isAllLoading:s,isPartialLoading:h,isAllError:R,isPartialError:r}}))},qe=(()=>{var n,i,p,s,h,R,r,ae,ue,le,pe,he,fe,me,Re,J,ge,Se,de;let C=class C extends L{constructor(){super(...arguments);x(this,r);x(this,n,{});x(this,i,new U);x(this,p,new z(null));x(this,s,I(ne));x(this,h,I(re));x(this,R,I(Z))}getRemoteResourceState(e){let t=g(this,n)[e];return t?t.asObservable():S(this,r,J).call(this,e)}triggerResource(e){g(this,n)[e]?this.reloadResource(e):S(this,r,J).call(this,e)}reloadResource(e){g(this,i).next(e)}};n=new WeakMap,i=new WeakMap,p=new WeakMap,s=new WeakMap,h=new WeakMap,R=new WeakMap,r=new WeakSet,ae=function(e,t){let o=0;return f([]).pipe(V(c=>{if(o>=e.length)return D;let u=e[o];return o++,S(this,r,he).call(this,{req:u,accumulatedRequestsResults:c,stateSubscriptionConfig:t}).pipe(m(a=>g(this,s).fetchData(u.fetcherId,a)),m(a=>S(this,r,me).call(this,u,a,c)),w(a=>[...c,a]))}),Y(),w(c=>c[e.length-1]))},ue=function(e,t){return S(this,r,fe).call(this,e,t).pipe(m(o=>B(o.map(({fetcherId:c,configs:u})=>g(this,s).fetchData(c,u)))),m(o=>S(this,r,Re).call(this,{reqs:e,responses:o,stateSubscriptionConfig:t})))},le=function(e){let t=g(this,n)[e];if(!t){console.warn(`Remote resource ${e} has not been registered or is not associated with any widget yet`);return}let o=g(this,h).getTemplate(e),c=S(this,r,pe).call(this,o,t),u=g(this,i).pipe(j(l=>l===e)),a=o.pipe(j(l=>l.status==="loaded"),m(l=>{let M=l.config.stateSubscription,k=f(D);return M&&(k=v(this.environmentInjector,()=>$(M,`Remote resource refresh trigger for ${e}`))),k}));F([u.pipe(G(!0)),a]).pipe(m(()=>c),K(g(this,p).pipe(j(l=>l===e)))).subscribe(()=>{te(`Remote resource ${e} triggered`)})},pe=function(e,t){return e.pipe(j(o=>o.status==="loaded"),N({next:()=>{this.setLoadingState(t)}}),m(o=>S(this,r,de).call(this,o.config).pipe(w(c=>({result:c,rrt:o})))),m(({result:o,rrt:c})=>(this.setCompleteState(t,o),S(this,r,ge).call(this,{resourceResult:o,remoteResourceTemplate:c}))),b(()=>(this.setErrorState(t),ie)))},he=function(e){let{req:t,accumulatedRequestsResults:o,stateSubscriptionConfig:c}=e;return this.getResourceRequestConfigInterpolationContext(o,c).pipe(m(l=>this.interpolationService.interpolate({value:t.configs,context:l})),b(l=>{throw console.warn(`Fail to interpolate request options: ${l}`),l}),W())},fe=function(e,t){let o=t?v(this.environmentInjector,()=>$(t,"Parallel resource request options interpolation context")):f(null),c=e.map(a=>({fetcherId:a.fetcherId,configs:a.configs}));return o.pipe(m(a=>this.interpolationService.interpolate({value:c,context:a??{}})),b(a=>{throw console.warn("Fail to interpolate parallel requests options"),a}))},me=function(e,t,o){let{interpolation:c}=e;return c?this.getResourceRequestTransformationInterpolationContext({accumulatedRequestsResults:o,currentRequestResult:t}).pipe(m(l=>this.interpolationService.interpolate({value:c,context:l})),b(l=>{throw console.warn("Failed to interpolate sequenced request result: ",l),l})):f(t)},Re=function(e){let{reqs:t,responses:o,stateSubscriptionConfig:c}=e,u=[];for(let a=0;a<t.length;a++){let{interpolation:l}=t[a];if(l){let k=this.getResourceRequestTransformationInterpolationContext({currentRequestResult:o[a],stateSubscriptionConfig:c}).pipe(m(E=>this.interpolationService.interpolate({value:l,context:E})),b(E=>{throw console.warn("Failed to interpolate parallel request result",E),E}),W());u.push(k)}}return B(u)},J=function(e){let t=new z({status:"init",isLoading:!0,isError:!1,result:null});return g(this,n)[e]=t,S(this,r,le).call(this,e),t.asObservable()},ge=function(e){let{resourceResult:t,remoteResourceTemplate:o}=e,{config:{options:{onSuccess:c},stateSubscription:u}}=o;return!c?.length||t===se?ie:this.interpolateResourceHooks({onSuccessHooks:c,resourceResult:t,stateSubscription:u}).pipe(w(a=>(v(this.environmentInjector,()=>{g(this,R).triggerActionHooks(a)}),ce)))},Se=function(e){let{stateSubscription:t,runCondition:o}=e;return(t?v(this.environmentInjector,()=>$(t,"Resource run condition")):f({})).pipe(m(u=>this.interpolationService.interpolate({value:o,context:{state:u}})),b(u=>(console.warn("Failed to interpolate resource run condition: ",u),f(!1))))},de=function(e){let{stateSubscription:t,options:{runCondition:o=!0,requests:c,parallel:u}}=e;return S(this,r,Se).call(this,{stateSubscription:t,runCondition:o}).pipe(m(a=>a?u?S(this,r,ue).call(this,c,t):S(this,r,ae).call(this,c,t):f(se)))},C.\u0275fac=(()=>{let e;return function(o){return(e||(e=X(C)))(o||C)}})(),C.\u0275prov=y({token:C,factory:C.\u0275fac,providedIn:"root"});let d=C;return d})();export{ne as a,Je as b,qe as c};
