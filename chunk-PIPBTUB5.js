import{b as ne}from"./chunk-QPCBXCVC.js";import{f as Q,h as Z,k as y,l as $,n as ee,q as te,v as oe}from"./chunk-POJFSOR5.js";import{Aa as G,Ac as j,Bc as b,Ca as K,Cc as S,F as D,Fc as J,J as N,L as W,S as A,U as O,V as P,W as V,X as q,_ as B,a as f,b as v,ba as H,ea as E,fb as z,ha as Y,ia as x,j as U,k as L,mb as X,n as w,p as F,q as I,w as g,x as T,xa as _,za as R}from"./chunk-CELOEL42.js";var k=l=>{let C=K(void 0);return S(n=>{let t=l().subscribe(o=>C.set(o));n(()=>{t.unsubscribe()})}),C};var M=l=>{let{ele:C,attrName:n,attrValue:e}=l,t=C.parentElement,o=[];for(;t;){let r=t.getAttribute(n);if(r===null){t=t.parentElement;continue}if(o.push(r),r===e)return{contains:!0,chain:o};t=t.parentElement}return{contains:!1,chain:o}};var re=(()=>{class l{#t={};#n={};registerUIElement(n){let{type:e,component:t}=n;this.#t[e]=t}registerUIElementLoader(n){let{type:e,loader:t}=n;this.#n[e]=t}getUIElement(n){let e=this.#t[n];if(!e){let t=this.#n[n];if(t)return t();throw new Error(`${n} has not been registered as a UI Element yet!`)}return Promise.resolve(e)}static{this.\u0275fac=function(e){return new(e||l)}}static{this.\u0275prov=B({token:l,factory:l.\u0275fac,providedIn:"root"})}}return l})();var se=new H("ELEMENT_RENDERER_CONFIG"),ke=(()=>{class l{constructor(){this.#t=E(re),this.#n=E(oe),this.#o=E(ee),this.#s=E(Y),this.#p=E(Z),this.#m=E(G),this.#e=E(z),this.#r=E(se,{optional:!0}),this.#a=this.#r?.uiElementLoadingComponent,this.#l=this.#r?.uiElementInfiniteErrorComponent,this.#i=this.#r?.uiElementWrapperComponent,this.uiElementTemplateId=R.required({alias:"djuiUIElementRenderer"}),this.requiredComponentSymbols=R([]),this.configsOverride=R({}),this.uiElementTemplate=k(()=>this.#n.getTemplate(this.uiElementTemplateId())),this.uiElementComponent=k(()=>{let n=this.uiElementTemplate();return!n||!n.config?I(void 0):F(this.#t.getUIElement(n.config.type))}),this.#u=b(()=>{this.#e.clear();let n=this.uiElementTemplate();if(n?.status!=="loaded")return this.#a&&this.#e.createComponent(this.#a),null;if(this.isInfinite())return this.#l&&this.#e.createComponent(this.#l),null;let e=this.uiElementComponent();if(!e)return null;let t=j(this.uiElementTemplateId),o=e.ELEMENT_SYMBOL,r=this.requiredComponentSymbols();if(!this.#g(e,r))return y(`${t}: Wrong element received: expect ${r.map(m=>String(m)).join("or ")} but got ${String(o)}`),null;let i=this.#b(o);if(i){i.setInput("uiElementTemplate",n.config);let m=i.instance.uiElementVCR();if(!m)return null;let c=m.createComponent(e);return i.setInput("uiElementComponentRef",c),c}return this.#e.createComponent(e)}),this.#c=b(()=>{let n=this.uiElementTemplate();if(!n||n.status!=="loaded")return null;let{remoteResourceIds:e,stateSubscription:t}=n.config,o=t?x(this.#s,()=>te(t,`UI Element ${n.id}`)):I(null),r=e?.length?x(this.#s,()=>ne(e)):I(null);return T({remoteResourcesStates:r,state:o}).pipe(A({refCount:!0,bufferSize:1}))}),this.#f=b(()=>{let n=this.uiElementTemplate(),e=this.#c();if(n?.status!=="loaded"||!e)return null;let{config:{options:t,remoteResourceIds:o}}=n,r=o?.length?this.#I({elementInterpolationContext$:e}):{isResourceLoading:I(!1),isResourceError:I(!1)},i=this.#h({templateOptions:t,elementInterpolationContext$:e}),m={isLoading:T({isResourceLoading:r.isResourceLoading,isInterpolationLoading:i.isInterpolationLoading}).pipe(g(({isResourceLoading:a,isInterpolationLoading:u})=>a||u)),isError:T({isResourceError:r.isResourceError,isInterpolationError:i.isInterpolationError}).pipe(g(({isResourceError:a,isInterpolationError:u})=>a||u))},c=Object.entries(this.configsOverride()).reduce((a,[u,p])=>v(f({},a),{[u]:I(p)}),{}),d=f(f(f(f({},r),m),i),c);return Object.fromEntries(Object.entries(d).map(([a,u])=>[a,u.pipe(W(Q),q(500,void 0,{leading:!0,trailing:!0}))]))}),this.isInfinite=b(()=>{let n=this.uiElementTemplateId(),e=this.#m.nativeElement,{contains:t,chain:o}=M({ele:e,attrName:"elementTemplateId",attrValue:n});if(t){let r=[...o,n].join(" -> ");console.error(`UI element with id ${n} has already existed in parents. Check ${r}`)}return t}),this.#E=S(n=>{let e=this.#f(),t=this.#u(),o=this.uiElementTemplate(),r=this.#c();if(!e||!t||o?.status!=="loaded"||!r)return;t.location.nativeElement.setAttribute("elementTemplateId",j(this.uiElementTemplateId));let i=new U;n(()=>{i.next(),i.complete()});for(let[c,d]of Object.entries(e))this.#d(t.componentType,c)?d.pipe(P(i)).subscribe(s=>{$(`[${this.uiElementTemplateId()}] Input stream for ${c}`),t.setInput(c,s)}):y(`Input ${c} does not exist for component ${t.instance.getElementType()}`);let{eventsHooks:m}=o.config;if(m)for(let[c,d]of Object.entries(m)){let s=t.instance[c];if(!s||!(s instanceof _))y(`Element ${t.instance.getElementType()} has no support for event "${c}"`);else{let a=r.pipe(N(1));s.subscribe(u=>{a.pipe(O(p=>this.#o.interpolate({value:d,context:v(f({},p),{$eventOutput:u})}))).subscribe(p=>{$(`Output stream for ${this.uiElementTemplateId()}`),this.#p.triggerActionHooks(p)})})}}})}#t;#n;#o;#s;#p;#m;#e;#r;#a;#l;#i;#u;#c;#f;#E;#d(n,e){let t=J(n)?.inputs;if(!t)throw new Error("Invalid component");return!!t.find(o=>o.propName===e||o.templateName===e)}#h(n){let{templateOptions:e,elementInterpolationContext$:t}=n,o=new L({}),r=o.asObservable().pipe(g(s=>!Object.values(s).every(a=>!a))),i=new L({}),m=i.asObservable().pipe(g(s=>!Object.values(s).every(a=>!a))),c={isInterpolationLoading:r,isInterpolationError:m},d={};for(let[s,a]of Object.entries(e)){let u=this.#o.checkForInterpolation(a);d[s]=u?t.pipe(O(p=>{let h=structuredClone(o.getValue());return h[s]=!0,o.next(h),this.#o.interpolate({context:p,value:a})}),D(p=>{let h=structuredClone(i.getValue());return h[s]=!0,i.next(h),console.warn(`Fail to interpolate ${s}. Error: ${p}`),w}),V({next:()=>{let p=structuredClone(i.getValue());p[s]=!1,i.next(p);let h=structuredClone(o.getValue());h[s]=!1,o.next(h)}})):I(a)}return f(f({},c),d)}#I(n){let{elementInterpolationContext$:e}=n;return{isResourceLoading:e.pipe(g(t=>!!t.remoteResourcesStates?.isPartialLoading.length)),isResourceError:e.pipe(g(t=>!!t.remoteResourcesStates?.isPartialError.length))}}#g(n,e){let t=n.ELEMENT_SYMBOL;return!(e.length&&!e.includes(t))}#b(n){if(!this.#i)return null;let e=this.#i.EXCLUDED_ELEMENTS;return e&&!e.has(n)?this.#e.createComponent(this.#i):null}static{this.\u0275fac=function(e){return new(e||l)}}static{this.\u0275dir=X({type:l,selectors:[["","djuiUIElementRenderer",""]],inputs:{uiElementTemplateId:[1,"djuiUIElementRenderer","uiElementTemplateId"],requiredComponentSymbols:[1,"requiredComponentSymbols"],configsOverride:[1,"configsOverride"]}})}}return l})();export{re as a,se as b,ke as c};
