import{d as me}from"./chunk-4BVSUIFK.js";import{f as le,h as A,j as pe,k as q,l as L,n as N,q as v,v as he}from"./chunk-POJFSOR5.js";import{Aa as ie,Ac as z,Bc as O,C as V,Ca as se,Cc as P,E as w,F as C,Fc as ue,J as X,L as Q,M as Z,O as B,Q as _,S as y,T as ee,U as m,V as M,W as D,X as te,_ as j,a as g,b as T,ba as ne,ea as d,fb as ce,ha as U,ia as I,j as k,k as $,mb as ae,n as F,oa as oe,p as J,q as a,w as E,x as S,xa as re,za as H}from"./chunk-CELOEL42.js";var Y=c=>{let p=se(void 0);return P(e=>{let n=c().subscribe(o=>p.set(o));e(()=>{n.unsubscribe()})}),p};var G=c=>{let{ele:p,attrName:e,attrValue:t}=c,n=p.parentElement,o=[];for(;n;){let i=n.getAttribute(e);if(i===null){n=n.parentElement;continue}if(o.push(i),i===t)return{contains:!0,chain:o};n=n.parentElement}return{contains:!1,chain:o}};var fe=(()=>{class c{#e={};registerFetcher(e,t){this.#e[e]&&q(`Fetcher with id ${e} already exists. Registering it again will override it`),this.#e[e]=t}registerFetchers(e){for(let[t,n]of Object.entries(e))this.registerFetcher(t,n)}getFetcher(e){let t=this.#e[e];if(!t){let n=`Fetcher with id ${e} does not exists. Please register it first`;throw pe(n),new Error(n)}return t}fetchData(e,t){return this.getFetcher(e)(t)}static{this.\u0275fac=function(t){return new(t||c)}}static{this.\u0275prov=j({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();var W=class{constructor(){this.environmentInjector=d(U),this.interpolationService=d(N)}setLoadingState(p){let e=p.getValue();p.next(T(g({},e),{isLoading:!0}))}setErrorState(p){p.next({status:"error",isLoading:!1,isError:!0,result:null})}setCompleteState(p,e){p.next({status:"completed",isLoading:!1,isError:!1,result:e})}interpolateResourceHooks(p){let{onSuccessHooks:e,resourceResult:t,stateSubscription:n}=p;return this.getResourceRequestHooksInterpolationContext(t,n).pipe(m(r=>this.interpolationService.interpolate({value:e,context:r})),C(()=>(console.warn("Failed to interpolate resource hooks"),a([]))))}getResourceRequestConfigInterpolationContext(p,e){let t=e?I(this.environmentInjector,()=>v(e,"Resource configs interpolation context")):a(null),n=a(p);return S({$requests:n,state:t}).pipe(y({refCount:!0,bufferSize:1}))}getResourceRequestTransformationInterpolationContext(p){let{accumulatedRequestsResults:e,currentRequestResult:t,stateSubscriptionConfig:n}=p,o=n?I(this.environmentInjector,()=>v(n,"Resource transformation interpolation context")):a(null),i=a(e),r=a(t);return S({$requests:i,state:o,$current:r}).pipe(y({refCount:!0,bufferSize:1}))}getResourceRequestHooksInterpolationContext(p,e){let t=e?I(this.environmentInjector,()=>v(e,"Resource hooks interpolation context")):a(null),n=a(p);return S({$result:n,state:t}).pipe(y({refCount:!0,bufferSize:1}))}};var de="[Resource did not run]",Ee=Symbol("Complete"),ge=a(Ee),Re=c=>{let p=d(be),e=c.reduce((t,n)=>T(g({},t),{[n]:p.getRemoteResourceState(n)}),{});return S(e).pipe(E(t=>{let n=Object.entries(t).every(([,s])=>s.isLoading),o=Object.entries(t).reduce((s,[u,h])=>h.isLoading?[...s,u]:s,[]),i=Object.entries(t).every(([,s])=>s.isError),r=Object.entries(t).reduce((s,[u,h])=>h.isError?[...s,u]:s,[]);return{results:t,isAllLoading:n,isPartialLoading:o,isAllError:i,isPartialError:r}}))},be=(()=>{class c extends W{#e={};#t=new k;#o=new $(null);#r=d(fe);#l=d(me);#p=d(A);getRemoteResourceState(e){let t=this.#e[e];return t?t.asObservable():this.#f(e)}triggerResource(e){this.#e[e]?this.reloadResource(e):this.#f(e)}reloadResource(e){this.#t.next(e)}#n(e,t){let n=0;return a([]).pipe(Z(o=>{if(n>=e.length)return F;let i=e[n];return n++,this.#s({req:i,accumulatedRequestsResults:o,stateSubscriptionConfig:t}).pipe(m(r=>this.#r.fetchData(i.fetcherId,r)),m(r=>this.#u(i,r,o)),E(r=>[...o,r]))}),_(),E(o=>o[e.length-1]))}#i(e,t){return this.#m(e,t).pipe(m(n=>V(n.map(({fetcherId:o,configs:i})=>this.#r.fetchData(o,i)))),m(n=>this.#h({reqs:e,responses:n,stateSubscriptionConfig:t})))}#c(e){let t=this.#e[e];if(!t){console.warn(`Remote resource ${e} has not been registered or is not associated with any widget yet`);return}let n=this.#l.getTemplate(e),o=this.#a(n,t),i=this.#t.pipe(w(s=>s===e)),r=n.pipe(w(s=>s.status==="loaded"),m(s=>{let u=s.config.stateSubscription,h=a(F);return u&&(h=I(this.environmentInjector,()=>v(u,`Remote resource refresh trigger for ${e}`))),h}));S([i.pipe(ee(!0)),r]).pipe(m(()=>o),M(this.#o.pipe(w(s=>s===e)))).subscribe(()=>{L(`Remote resource ${e} triggered`)})}#a(e,t){return e.pipe(w(n=>n.status==="loaded"),D({next:()=>{this.setLoadingState(t)}}),m(n=>this.#E(n.config).pipe(E(o=>({result:o,rrt:n})))),m(({result:n,rrt:o})=>(this.setCompleteState(t,n),this.#d({resourceResult:n,remoteResourceTemplate:o}))),C(()=>(this.setErrorState(t),ge)))}#s(e){let{req:t,accumulatedRequestsResults:n,stateSubscriptionConfig:o}=e;return this.getResourceRequestConfigInterpolationContext(n,o).pipe(m(s=>this.interpolationService.interpolate({value:t.configs,context:s})),C(s=>{throw console.warn(`Fail to interpolate request options: ${s}`),s}),B())}#m(e,t){let n=t?I(this.environmentInjector,()=>v(t,"Parallel resource request options interpolation context")):a(null),o=e.map(r=>({fetcherId:r.fetcherId,configs:r.configs}));return n.pipe(m(r=>this.interpolationService.interpolate({value:o,context:r??{}})),C(r=>{throw console.warn("Fail to interpolate parallel requests options"),r}))}#u(e,t,n){let{interpolation:o}=e;return o?this.getResourceRequestTransformationInterpolationContext({accumulatedRequestsResults:n,currentRequestResult:t}).pipe(m(s=>this.interpolationService.interpolate({value:o,context:s})),C(s=>{throw console.warn("Failed to interpolate sequenced request result: ",s),s})):a(t)}#h(e){let{reqs:t,responses:n,stateSubscriptionConfig:o}=e,i=[];for(let r=0;r<t.length;r++){let{interpolation:s}=t[r];if(s){let h=this.getResourceRequestTransformationInterpolationContext({currentRequestResult:n[r],stateSubscriptionConfig:o}).pipe(m(l=>this.interpolationService.interpolate({value:s,context:l})),C(l=>{throw console.warn("Failed to interpolate parallel request result",l),l}),B());i.push(h)}}return V(i)}#f(e){let t=new $({status:"init",isLoading:!0,isError:!1,result:null});return this.#e[e]=t,this.#c(e),t.asObservable()}#d(e){let{resourceResult:t,remoteResourceTemplate:n}=e,{config:{options:{onSuccess:o},stateSubscription:i}}=n;return!o?.length||t===de?ge:this.interpolateResourceHooks({onSuccessHooks:o,resourceResult:t,stateSubscription:i}).pipe(E(r=>(I(this.environmentInjector,()=>{this.#p.triggerActionHooks(r)}),Ee)))}#g(e){let{stateSubscription:t,runCondition:n}=e;return(t?I(this.environmentInjector,()=>v(t,"Resource run condition")):a({})).pipe(m(i=>this.interpolationService.interpolate({value:n,context:{state:i}})),C(i=>(console.warn("Failed to interpolate resource run condition: ",i),a(!1))))}#E(e){let{stateSubscription:t,options:{runCondition:n=!0,requests:o,parallel:i}}=e;return this.#g({stateSubscription:t,runCondition:n}).pipe(m(r=>r?i?this.#i(o,t):this.#n(o,t):a(de)))}static{this.\u0275fac=(()=>{let e;return function(n){return(e||(e=oe(c)))(n||c)}})()}static{this.\u0275prov=j({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();var Ie=(()=>{class c{#e={};#t={};registerUIElement(e){let{type:t,component:n}=e;this.#e[t]=n}registerUIElementLoader(e){let{type:t,loader:n}=e;this.#t[t]=n}getUIElement(e){let t=this.#e[e];if(!t){let n=this.#t[e];if(n)return n();throw new Error(`${e} has not been registered as a UI Element yet!`)}return Promise.resolve(t)}static{this.\u0275fac=function(t){return new(t||c)}}static{this.\u0275prov=j({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();var Se=new ne("ELEMENT_RENDERER_CONFIG"),ft=(()=>{class c{constructor(){this.#e=d(Ie),this.#t=d(he),this.#o=d(N),this.#r=d(U),this.#l=d(A),this.#p=d(ie),this.#n=d(ce),this.#i=d(Se,{optional:!0}),this.#c=this.#i?.uiElementLoadingComponent,this.#a=this.#i?.uiElementInfiniteErrorComponent,this.#s=this.#i?.uiElementWrapperComponent,this.uiElementTemplateId=H.required({alias:"djuiUIElementRenderer"}),this.requiredComponentSymbols=H([]),this.configsOverride=H({}),this.uiElementTemplate=Y(()=>this.#t.getTemplate(this.uiElementTemplateId())),this.uiElementComponent=Y(()=>{let e=this.uiElementTemplate();return!e||!e.config?a(void 0):J(this.#e.getUIElement(e.config.type))}),this.#m=O(()=>{this.#n.clear();let e=this.uiElementTemplate();if(e?.status!=="loaded")return this.#c&&this.#n.createComponent(this.#c),null;if(this.isInfinite())return this.#a&&this.#n.createComponent(this.#a),null;let t=this.uiElementComponent();if(!t)return null;let n=z(this.uiElementTemplateId),o=t.ELEMENT_SYMBOL,i=this.requiredComponentSymbols();if(!this.#R(t,i))return q(`${n}: Wrong element received: expect ${i.map(s=>String(s)).join("or ")} but got ${String(o)}`),null;let r=this.#I(o);if(r){r.setInput("uiElementTemplate",e.config);let s=r.instance.uiElementVCR();if(!s)return null;let u=s.createComponent(t);return r.setInput("uiElementComponentRef",u),u}return this.#n.createComponent(t)}),this.#u=O(()=>{let e=this.uiElementTemplate();if(!e||e.status!=="loaded")return null;let{remoteResourceIds:t,stateSubscription:n}=e.config,o=n?I(this.#r,()=>v(n,`UI Element ${e.id}`)):a(null),i=t?.length?I(this.#r,()=>Re(t)):a(null);return S({remoteResourcesStates:i,state:o}).pipe(y({refCount:!0,bufferSize:1}))}),this.#h=O(()=>{let e=this.uiElementTemplate(),t=this.#u();if(e?.status!=="loaded"||!t)return null;let{config:{options:n,remoteResourceIds:o}}=e,i=o?.length?this.#E({elementInterpolationContext$:t}):{isResourceLoading:a(!1),isResourceError:a(!1)},r=this.#g({templateOptions:n,elementInterpolationContext$:t}),s={isLoading:S({isResourceLoading:i.isResourceLoading,isInterpolationLoading:r.isInterpolationLoading}).pipe(E(({isResourceLoading:f,isInterpolationLoading:b})=>f||b)),isError:S({isResourceError:i.isResourceError,isInterpolationError:r.isInterpolationError}).pipe(E(({isResourceError:f,isInterpolationError:b})=>f||b))},u=Object.entries(this.configsOverride()).reduce((f,[b,R])=>T(g({},f),{[b]:a(R)}),{}),h=g(g(g(g({},i),s),r),u);return Object.fromEntries(Object.entries(h).map(([f,b])=>[f,b.pipe(Q(le),te(500,void 0,{leading:!0,trailing:!0}))]))}),this.isInfinite=O(()=>{let e=this.uiElementTemplateId(),t=this.#p.nativeElement,{contains:n,chain:o}=G({ele:t,attrName:"elementTemplateId",attrValue:e});if(n){let i=[...o,e].join(" -> ");console.error(`UI element with id ${e} has already existed in parents. Check ${i}`)}return n}),this.#f=P(e=>{let t=this.#h(),n=this.#m(),o=this.uiElementTemplate(),i=this.#u();if(!t||!n||o?.status!=="loaded"||!i)return;n.location.nativeElement.setAttribute("elementTemplateId",z(this.uiElementTemplateId));let r=new k;e(()=>{r.next(),r.complete()});for(let[u,h]of Object.entries(t))this.#d(n.componentType,u)?h.pipe(M(r)).subscribe(l=>{L(`[${this.uiElementTemplateId()}] Input stream for ${u}`),n.setInput(u,l)}):q(`Input ${u} does not exist for component ${n.instance.getElementType()}`);let{eventsHooks:s}=o.config;if(s)for(let[u,h]of Object.entries(s)){let l=n.instance[u];if(!l||!(l instanceof re))q(`Element ${n.instance.getElementType()} has no support for event "${u}"`);else{let f=i.pipe(X(1));l.subscribe(b=>{f.pipe(m(R=>this.#o.interpolate({value:h,context:T(g({},R),{$eventOutput:b})}))).subscribe(R=>{L(`Output stream for ${this.uiElementTemplateId()}`),this.#l.triggerActionHooks(R)})})}}})}#e;#t;#o;#r;#l;#p;#n;#i;#c;#a;#s;#m;#u;#h;#f;#d(e,t){let n=ue(e)?.inputs;if(!n)throw new Error("Invalid component");return!!n.find(o=>o.propName===t||o.templateName===t)}#g(e){let{templateOptions:t,elementInterpolationContext$:n}=e,o=new $({}),i=o.asObservable().pipe(E(l=>!Object.values(l).every(f=>!f))),r=new $({}),s=r.asObservable().pipe(E(l=>!Object.values(l).every(f=>!f))),u={isInterpolationLoading:i,isInterpolationError:s},h={};for(let[l,f]of Object.entries(t)){let b=this.#o.checkForInterpolation(f);h[l]=b?n.pipe(m(R=>{let x=structuredClone(o.getValue());return x[l]=!0,o.next(x),this.#o.interpolate({context:R,value:f})}),C(R=>{let x=structuredClone(r.getValue());return x[l]=!0,r.next(x),console.warn(`Fail to interpolate ${l}. Error: ${R}`),F}),D({next:()=>{let R=structuredClone(r.getValue());R[l]=!1,r.next(R);let x=structuredClone(o.getValue());x[l]=!1,o.next(x)}})):a(f)}return g(g({},u),h)}#E(e){let{elementInterpolationContext$:t}=e;return{isResourceLoading:t.pipe(E(n=>!!n.remoteResourcesStates?.isPartialLoading.length)),isResourceError:t.pipe(E(n=>!!n.remoteResourcesStates?.isPartialError.length))}}#R(e,t){let n=e.ELEMENT_SYMBOL;return!(t.length&&!t.includes(n))}#I(e){if(!this.#s)return null;let t=this.#s.EXCLUDED_ELEMENTS;return t&&!t.has(e)?this.#n.createComponent(this.#s):null}static{this.\u0275fac=function(t){return new(t||c)}}static{this.\u0275dir=ae({type:c,selectors:[["","djuiUIElementRenderer",""]],inputs:{uiElementTemplateId:[1,"djuiUIElementRenderer","uiElementTemplateId"],requiredComponentSymbols:[1,"requiredComponentSymbols"],configsOverride:[1,"configsOverride"]}})}}return c})();export{fe as a,be as b,Ie as c,Se as d,ft as e};
